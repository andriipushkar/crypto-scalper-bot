# Тести ризик-менеджменту

## 1. Position Size Limits

### TC-127: Max position size USD
**Кроки:**
1. Встановити max_position_usd = $500
2. Спробувати відкрити позицію $600

**Очікуваний результат:**
- [ ] Позиція заблокована
- [ ] Помилка "Position size exceeds limit"
- [ ] Можна відкрити <= $500

### TC-128: Max position size per symbol
**Кроки:**
1. Встановити ліміт для конкретного символу
2. Перевірити

**Очікуваний результат:**
- [ ] Ліміт діє тільки для цього символу
- [ ] Інші символи мають свої ліміти

### TC-129: Max open positions
**Кроки:**
1. Встановити max_open_positions = 3
2. Відкрити 3 позиції
3. Спробувати відкрити 4-ту

**Очікуваний результат:**
- [ ] 4-та позиція заблокована
- [ ] Помилка "Max positions reached"
- [ ] Закрити одну -> можна відкрити нову

---

## 2. Loss Limits

### TC-130: Max daily loss
**Кроки:**
1. Встановити max_daily_loss = $50
2. Зазнати збитків на $50

**Очікуваний результат:**
- [ ] Торгівля призупиняється
- [ ] Нові позиції заблоковані
- [ ] Повідомлення "Daily loss limit reached"
- [ ] Скидання о 00:00 UTC

### TC-131: Max drawdown
**Кроки:**
1. Встановити max_drawdown = 10%
2. Equity падає на 10% від peak

**Очікуваний результат:**
- [ ] Торгівля призупиняється
- [ ] Alert користувачу
- [ ] Позиції можуть бути auto-closed

### TC-132: Max loss per trade
**Кроки:**
1. Встановити risk_per_trade = 2%
2. Позиція досягає -2%

**Очікуваний результат:**
- [ ] SL спрацьовує автоматично
- [ ] Збиток не перевищує 2%

### TC-133: Consecutive losses limit
**Кроки:**
1. Встановити max_consecutive_losses = 5
2. Отримати 5 збиткових угод підряд

**Очікуваний результат:**
- [ ] Торгівля призупиняється
- [ ] Cooldown період
- [ ] Потрібно manual restart

---

## 3. Leverage Limits

### TC-134: Max leverage limit
**Кроки:**
1. Встановити max_leverage = 20x
2. Спробувати встановити 50x

**Очікуваний результат:**
- [ ] Leverage обмежено до 20x
- [ ] Попередження користувачу

### TC-135: Dynamic leverage based on volatility
**Кроки:**
1. Увімкнути dynamic leverage
2. Волатильність зростає

**Очікуваний результат:**
- [ ] Leverage автоматично зменшується
- [ ] Більша волатильність = менший leverage

---

## 4. Exposure Limits

### TC-136: Total exposure limit
**Кроки:**
1. Встановити max_exposure = $5000
2. Поточна exposure $4000
3. Спробувати відкрити ще $1500

**Очікуваний результат:**
- [ ] Можна відкрити тільки до $1000
- [ ] Часткове виконання або блокування

### TC-137: Sector/Asset concentration
**Кроки:**
1. Всі позиції в BTC
2. Перевірити concentration warning

**Очікуваний результат:**
- [ ] Попередження про концентрацію
- [ ] Рекомендація диверсифікації

### TC-138: Correlated assets limit
**Кроки:**
1. Відкрити позиції в корельованих активах (BTC, ETH)

**Очікуваний результат:**
- [ ] Рахується як одна "grouped" позиція
- [ ] Risk адаптується до кореляції

---

## 5. Margin Management

### TC-139: Margin level warning
**Кроки:**
1. Margin level падає < 100%

**Очікуваний результат:**
- [ ] Warning alert
- [ ] Можливо auto-close частини позицій

### TC-140: Liquidation prevention
**Кроки:**
1. Позиція наближається до liquidation price

**Очікуваний результат:**
- [ ] Alert при 80% до liquidation
- [ ] Можливість auto-reduce position
- [ ] Рекомендація додати margin

### TC-141: Cross vs Isolated margin
**Кроки:**
1. Перемикнути режим margin

**Очікуваний результат:**
- [ ] Cross: всі позиції ділять margin
- [ ] Isolated: кожна позиція має свій margin
- [ ] Risk рахується відповідно

---

## 6. Time-based Limits

### TC-142: Max trades per day
**Кроки:**
1. Встановити max_trades_per_day = 10
2. Виконати 10 угод

**Очікуваний результат:**
- [ ] 11-та угода заблокована
- [ ] Скидання о 00:00 UTC

### TC-143: Max trades per hour
**Кроки:**
1. Встановити max_trades_per_hour = 5

**Очікуваний результат:**
- [ ] Ліміт дотримується
- [ ] Скидання щогодини

### TC-144: Trading hours restriction
**Кроки:**
1. Встановити allowed trading hours

**Очікуваний результат:**
- [ ] Торгівля тільки в дозволені години
- [ ] Блокування поза годинами

---

## 7. Risk Metrics Calculation

### TC-145: Win rate calculation
**Кроки:**
1. Виконати декілька угод
2. Перевірити win rate

**Очікуваний результат:**
- [ ] Win rate = winning_trades / total_trades * 100%
- [ ] Оновлюється після кожної угоди

### TC-146: Profit factor calculation
**Кроки:**
1. Перевірити profit factor

**Очікуваний результат:**
- [ ] PF = gross_profit / gross_loss
- [ ] PF > 1 = прибуткова система

### TC-147: Sharpe ratio calculation
**Кроки:**
1. Перевірити Sharpe ratio

**Очікуваний результат:**
- [ ] SR = (avg_return - risk_free_rate) / std_dev
- [ ] Правильний розрахунок

### TC-148: Sortino ratio calculation
**Кроки:**
1. Перевірити Sortino ratio

**Очікуваний результат:**
- [ ] Враховує тільки downside deviation
- [ ] Sortino >= Sharpe (зазвичай)

### TC-149: Max drawdown calculation
**Кроки:**
1. Перевірити max drawdown

**Очікуваний результат:**
- [ ] MDD = (peak - trough) / peak * 100%
- [ ] Історичний max записується

### TC-150: Value at Risk (VaR)
**Кроки:**
1. Перевірити VaR метрику

**Очікуваний результат:**
- [ ] 95% VaR розраховано
- [ ] Expected Shortfall (CVaR)

---

## 8. Risk Alerts

### TC-151: High drawdown alert
**Кроки:**
1. Drawdown > threshold

**Очікуваний результат:**
- [ ] Alert на UI
- [ ] Telegram notification (якщо налаштовано)
- [ ] Email (якщо налаштовано)

### TC-152: Approaching limit alert
**Кроки:**
1. Daily loss 80% від ліміту

**Очікуваний результат:**
- [ ] Попереджувальний alert
- [ ] Yellow warning indicator

### TC-153: Unusual activity alert
**Кроки:**
1. Багато угод за короткий час

**Очікуваний результат:**
- [ ] Anomaly detection alert
- [ ] Можливе auto-pause

---

## 9. Emergency Controls

### TC-154: Emergency stop all
**Кроки:**
1. Натиснути "Emergency Stop"

**Очікуваний результат:**
- [ ] Всі позиції закриваються
- [ ] Всі ордери скасовуються
- [ ] Bot зупиняється
- [ ] Confirmation required

### TC-155: Panic button
**Кроки:**
1. Натиснути panic button (якщо є)

**Очікуваний результат:**
- [ ] Миттєве закриття всіх позицій market order
- [ ] Логування emergency action

### TC-156: Auto-recovery після emergency
**Кроки:**
1. Після emergency stop
2. Перезапустити бота

**Очікуваний результат:**
- [ ] Bot запускається в safe mode
- [ ] Потрібно manual confirmation для торгівлі

---

## 10. Risk Configuration

### TC-157: Risk profile presets
**Кроки:**
1. Вибрати preset: Conservative, Moderate, Aggressive

**Очікуваний результат:**
- [ ] Conservative: low leverage, tight stops
- [ ] Moderate: balanced
- [ ] Aggressive: higher leverage, wider stops

### TC-158: Custom risk profile
**Кроки:**
1. Створити custom profile
2. Зберегти

**Очікуваний результат:**
- [ ] Profile збережено
- [ ] Можна перемикатись між profiles

### TC-159: Risk config export/import
**Кроки:**
1. Export risk settings
2. Import на іншій інсталяції

**Очікуваний результат:**
- [ ] Settings exported as JSON
- [ ] Import успішний
- [ ] Валідація при import
