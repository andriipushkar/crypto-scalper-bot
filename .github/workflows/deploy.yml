name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd $DEPLOY_PATH

            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}

            # Update docker-compose with new image
            export IMAGE_TAG=${{ inputs.image_tag }}

            # Rolling update
            docker compose pull
            docker compose up -d --no-deps --build bot dashboard

            # Health check
            sleep 10
            if docker compose ps | grep -q "unhealthy\|Exit"; then
              echo "Deployment failed - rolling back"
              docker compose rollback || docker compose up -d
              exit 1
            fi

            # Cleanup old images
            docker image prune -f

            echo "Deployment successful!"
          ENDSSH

      - name: Verify deployment
        run: |
          # Wait for service to be ready
          sleep 15

          # Check health endpoint
          HEALTH_URL="https://${{ secrets.SERVER_HOST }}/health"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Health check failed with status $HTTP_STATUS"
            exit 1
          fi

          echo "Deployment verified successfully"

      - name: Send notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            EMOJI="✅"
            STATUS="successful"
          else
            EMOJI="❌"
            STATUS="failed"
          fi

          MESSAGE="${EMOJI} Deployment to ${{ inputs.environment }} ${STATUS}

          Image: ${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}
          Triggered by: ${{ github.actor }}"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" || true

  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment: ${{ inputs.environment }}

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Rollback deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd $DEPLOY_PATH

            # Get previous image
            PREV_IMAGE=$(docker compose logs bot 2>&1 | grep -oP 'Using image: \K.*' | head -1)

            if [ -n "$PREV_IMAGE" ]; then
              docker compose down
              docker compose up -d
            fi

            echo "Rollback completed"
          ENDSSH

      - name: Send rollback notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="⚠️ Automatic rollback executed for ${{ inputs.environment }}

          Original deployment of ${{ inputs.image_tag }} failed.
          Previous version restored."

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" || true
