apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # Slack configuration
  service.slack: |
    token: $slack-token

  # Telegram configuration
  service.telegram: |
    token: $telegram-token

  # Templates
  template.app-deployed: |
    message: |
      Application {{.app.metadata.name}} has been deployed.
      Sync Status: {{.app.status.sync.status}}
      Health Status: {{.app.status.health.status}}
      Revision: {{.app.status.sync.revision}}

  template.app-sync-failed: |
    message: |
      Application {{.app.metadata.name}} sync failed!
      Error: {{.app.status.conditions | first | .message}}

  template.app-health-degraded: |
    message: |
      Application {{.app.metadata.name}} health is degraded!
      Health Status: {{.app.status.health.status}}

  # Triggers
  trigger.on-sync-succeeded: |
    - when: app.status.sync.status == 'Synced'
      send: [app-deployed]

  trigger.on-sync-failed: |
    - when: app.status.sync.status == 'OutOfSync' and app.status.operationState.phase == 'Failed'
      send: [app-sync-failed]

  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Subscriptions
  subscriptions: |
    - recipients:
        - slack:trading-alerts
        - telegram:trading-chat
      triggers:
        - on-sync-succeeded
        - on-sync-failed
        - on-health-degraded
      selector: environment=production
